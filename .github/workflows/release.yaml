name: Build and Release ESP32 Firmware

on:
  push:
    tags:
      - "v*" # Triggers on version tags like v1.0.0
  workflow_dispatch: # Allows manual trigger

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # For ESPHome projects
      - name: Build ESPHome firmware
        uses: esphome/build-action@v7
        id: esphome-build
        with:
          yaml-file: esphome/zero-grid.yaml # Replace with your YAML filename
          version: latest

      - name: Copy firmware files
        run: |
          mkdir -p release-files
          cp ${{ steps.esphome-build.outputs.name }}/*.bin release-files/
          cp ${{ steps.esphome-build.outputs.name }}/*.factory.bin release-files/ || true

      # # Create manifest for ESP Web Tools (web-based flasher)
      # - name: Create flash manifest
      #   run: |
      #     cat > release-files/manifest.json << EOF
      #     {
      #       "name": "Your ESP32 Device",
      #       "version": "${{ github.ref_name }}",
      #       "home_assistant_domain": "esphome",
      #       "new_install_prompt_erase": true,
      #       "builds": [
      #         {
      #           "chipFamily": "ESP32",
      #           "parts": [
      #             {
      #               "path": "firmware.bin",
      #               "offset": 65536
      #             },
      #             {
      #               "path": "bootloader.bin",
      #               "offset": 4096
      #             },
      #             {
      #               "path": "partitions.bin",
      #               "offset": 32768
      #             }
      #           ]
      #         }
      #       ]
      #     }
      #     EOF

      # # Create installation instructions
      # - name: Create flash instructions
      #   run: |
      #     cat > release-files/FLASH_INSTRUCTIONS.md << EOF
      #     # Flash Instructions

      #     ## Option 1: Using esptool.py (Command Line)
      #     \`\`\`bash
      #     pip install esptool
      #     esptool.py --chip esp32 --port /dev/ttyUSB0 --baud 460800 write_flash 0x0 firmware.bin
      #     \`\`\`

      #     ## Option 2: Using ESP Web Tools (Browser)
      #     Visit: https://web.esphome.io/
      #     Upload the .bin files from this release

      #     ## Option 3: Using factory.bin (Full flash)
      #     \`\`\`bash
      #     esptool.py --chip esp32 --port /dev/ttyUSB0 --baud 460800 write_flash 0x0 firmware.factory.bin
      #     \`\`\`

      #     Replace /dev/ttyUSB0 with your serial port (COM3 on Windows, /dev/cu.* on Mac)
      #     EOF

      # # Create GitHub Release
      # - name: Create Release
      #   uses: softprops/action-gh-release@v1
      #   if: startsWith(github.ref, 'refs/tags/')
      #   with:
      #     files: |
      #       release-files/*.bin
      #       release-files/manifest.json
      #       release-files/FLASH_INSTRUCTIONS.md
      #     body: |
      #       ## ESP32 Firmware Release ${{ github.ref_name }}

      #       ### ðŸ“¦ Files included:
      #       - `firmware.bin` - Main firmware binary
      #       - `firmware.factory.bin` - Factory reset binary (flash to 0x0)
      #       - `manifest.json` - Web flasher manifest
      #       - `FLASH_INSTRUCTIONS.md` - Detailed flash instructions

      #       ### ðŸš€ Quick Flash:
      #       Use [ESP Web Tools](https://web.esphome.io/) for browser-based flashing (easiest!)

      #       Or command line:
      #       ```bash
      #       esptool.py --port YOUR_PORT write_flash 0x0 firmware.factory.bin
      #       ```
      #     draft: false
      #     prerelease: false
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
